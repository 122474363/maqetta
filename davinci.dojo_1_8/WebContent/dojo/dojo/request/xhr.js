/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

//>>built
define("dojo/request/xhr",["require","./watch","./handlers","./util","../has"],function(_1,_2,_3,_4,_5){_5.add("native-xhr",function(){return typeof XMLHttpRequest!=="undefined";});_5.add("native-xhr2",function(){if(!_5("native-xhr")){return;}var x=new XMLHttpRequest();return typeof x["addEventListener"]!=="undefined";});function _6(_7){var _8=_7.xhr;_7.status=_7.xhr.status;_7.text=_8.responseText;if(_7.options.handleAs==="xml"){_7.data=_8.responseXML;}try{_3(_7);}catch(e){_7.error=e;}if(_7.error){this.reject(_7.error);}else{if(_4.checkStatus(_8.status)){this.resolve(_7);}else{var _9=new Error("Unable to load "+_7.url+" status: "+_8.status);_9.log=false;this.reject(_9);}}};var _a,_b,_c,_d;if(_5("native-xhr2")){_a=function(_e){return !this.isFulfilled();};_d=function(_f,_10){_10.xhr.abort();};_c=function(_11,dfd,_12){function _13(evt){dfd.handleResponse(_12);};function _14(evt){var _15=evt.target;_12.error=new Error("Unable to load "+_12.url+" status: "+_15.status);_12.error.log=false;dfd.handleResponse(_12);};function _16(evt){if(evt.lengthComputable){_12.loaded=evt.loaded;_12.total=evt.total;dfd.progress(_12);}};_11.addEventListener("load",_13,false);_11.addEventListener("error",_14,false);_11.addEventListener("progress",_16,false);return function(){_11.removeEventListener("load",_13,false);_11.removeEventListener("error",_14,false);_11.removeEventListener("progress",_16,false);};};}else{_a=function(_17){return _17.xhr.readyState;};_b=function(_18){return 4===_18.xhr.readyState;};_d=function(dfd,_19){var xhr=_19.xhr;var _1a=typeof xhr.abort;if(_1a==="function"||_1a==="object"||_1a==="unknown"){xhr.abort();}};}var _1b,_1c={data:null,query:null,sync:false,method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded"}};function xhr(url,_1d,_1e){var _1f=_4.parseArgs(url,_4.deepCreate(_1c,_1d));url=_1f.url;_1d=_1f.options;var _20,_21=function(){_20&&_20();};var dfd=_4.deferred(_1f,_d,_a,_b,_6,_21);var _22=_1f.xhr=xhr._create();if(!_22){dfd.cancel();return _1e?dfd:dfd.promise;}if(_c){_20=_c(_22,dfd,_1f);}var _23=_1d.data,_24=!_1d.sync,_25=_1d.method;_22.open(_25,url,_24,_1d.user||_1b,_1d.password||_1b);var _26=_1d.headers,_27;if(_26){for(var hdr in _26){if(hdr.toLowerCase()==="content-type"){_27=_26[hdr];}else{if(_26[hdr]){_22.setRequestHeader(hdr,_26[hdr]);}}}}if(_27&&_27!==false){_22.setRequestHeader("Content-Type",_27);}if(!_26||!("X-Requested-With" in _26)){_22.setRequestHeader("X-Requested-With","XMLHttpRequest");}try{var _28=_1("./notify");_28.send(_1f);}catch(e){}try{_22.send(_23);}catch(e){_1f.error=e;dfd.reject(e);}_2(dfd);_22=null;return _1e?dfd:dfd.promise;};xhr._create=function(){throw new Error("XMLHTTP not available");};if(_5("native-xhr")){xhr._create=function(){return new XMLHttpRequest();};}else{if(_5("activex")){try{new ActiveXObject("Msxml2.XMLHTTP");xhr._create=function(){return new ActiveXObject("Msxml2.XMLHTTP");};}catch(e){try{new ActiveXObject("Microsoft.XMLHTTP");xhr._create=function(){return new ActiveXObject("Microsoft.XMLHTTP");};}catch(e){}}}}_4.addCommonMethods(xhr);return xhr;});