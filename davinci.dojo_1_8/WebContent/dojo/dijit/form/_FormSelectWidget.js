//>>built
define("dijit/form/_FormSelectWidget",["dojo/_base/array","dojo/_base/Deferred","dojo/aspect","dojo/data/util/sorter","dojo/_base/declare","dojo/dom","dojo/dom-class","dojo/_base/kernel","dojo/_base/lang","dojo/query","dojo/when","dojo/store/util/QueryResults","./_FormValueWidget"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){return _5("dijit.form._FormSelectWidget",_d,{multiple:false,options:null,store:null,query:null,queryOptions:null,labelAttr:"",onFetch:null,sortByLabel:true,loadChildrenOnOpen:false,onLoadDeferred:null,getOptions:function(_e){var _f=_e,_10=this.options||[],l=_10.length;if(_f===undefined){return _10;}if(_9.isArray(_f)){return _1.map(_f,"return this.getOptions(item);",this);}if(_9.isObject(_e)){if(!_1.some(this.options,function(o,idx){if(o===_f||(o.value&&o.value===_f.value)){_f=idx;return true;}return false;})){_f=-1;}}if(typeof _f=="string"){for(var i=0;i<l;i++){if(_10[i].value===_f){_f=i;break;}}}if(typeof _f=="number"&&_f>=0&&_f<l){return this.options[_f];}return null;},addOption:function(_11){if(!_9.isArray(_11)){_11=[_11];}_1.forEach(_11,function(i){if(i&&_9.isObject(i)){this.options.push(i);}},this);this._loadChildren();},removeOption:function(_12){if(!_9.isArray(_12)){_12=[_12];}var _13=this.getOptions(_12);_1.forEach(_13,function(i){if(i){this.options=_1.filter(this.options,function(_14){return (_14.value!==i.value||_14.label!==i.label);});this._removeOptionItem(i);}},this);this._loadChildren();},updateOption:function(_15){if(!_9.isArray(_15)){_15=[_15];}_1.forEach(_15,function(i){var _16=this.getOptions(i),k;if(_16){for(k in i){_16[k]=i[k];}}},this);this._loadChildren();},setStore:function(_17,_18,_19){var _1a=this.store;_19=_19||{};if(_1a!==_17){var h;while((h=this._notifyConnections.pop())){h.remove();}if(!_17.get){_9.mixin(_17,{_oldAPI:true,get:function(id){var _1b=new _2();this.fetchItemByIdentity({identity:id,onItem:function(_1c){_1b.resolve(_1c);},onError:function(_1d){_1b.reject(_1d);}});return _1b.promise;},query:function(_1e,_1f){var _20,_21=new _2(function(){if(_20.abort){_20.abort();}});_20=this.fetch(_9.mixin({query:_1e,onBegin:function(_22){_21.total=_22;},onComplete:function(_23){_21.resolve(_23);},onError:function(_24){_21.reject(_24);}},_1f));return new _c(_21);}});if(_17.getFeatures()["dojo.data.api.Notification"]){this._notifyConnections=[_3.after(_17,"onNew",_9.hitch(this,"_onNewItem"),true),_3.after(_17,"onDelete",_9.hitch(this,"_onDeleteItem"),true),_3.after(_17,"onSet",_9.hitch(this,"_onSetItem"),true)];}}this._set("store",_17);}if(this.options&&this.options.length){this.removeOption(this.options);}if(this._queryRes&&this._queryRes.close){this._queryRes.close();}if(_19.query){this._set("query",_19.query);this._set("queryOptions",_19.queryOptions);}if(_17){this._loadingStore=true;this.onLoadDeferred=new _2();this._queryRes=_17.query(this.query,this.queryOptions);_b(this._queryRes,_9.hitch(this,function(_25){if(this.sortByLabel&&!_19.sort&&_25.length){if(_25[0].getValue){_25.sort(_4.createSortFunction([{attribute:_17.getLabelAttributes(_25[0])[0]}],_17));}else{var _26=this.labelAttr;_25.sort(function(a,b){return a[_26]>b[_26]?1:b[_26]>a[_26]?-1:0;});}}if(_19.onFetch){_25=_19.onFetch.call(this,_25,_19);}_1.forEach(_25,function(i){this._addOptionForItem(i);},this);if(this._queryRes.observe){this._queryRes.observe(_9.hitch(this,function(_27,_28,_29){if(_28==_29){this._onSetItem(_27);}else{if(_28!=-1){this._onDeleteItem(_27);}if(_29!=-1){this._onNewItem(_27);}}}),true);}this._loadingStore=false;this.set("value","_pendingValue" in this?this._pendingValue:_18);delete this._pendingValue;if(!this.loadChildrenOnOpen){this._loadChildren();}else{this._pseudoLoadChildren(_25);}this.onLoadDeferred.resolve(true);this.onSetStore();}),function(err){console.error("dijit.form.Select: "+err.toString());this.onLoadDeferred.reject(err);});}return _1a;},_setValueAttr:function(_2a,_2b){if(!this._onChangeActive){_2b=null;}if(this._loadingStore){this._pendingValue=_2a;return;}var _2c=this.getOptions()||[];if(!_9.isArray(_2a)){_2a=[_2a];}_1.forEach(_2a,function(i,idx){if(!_9.isObject(i)){i=i+"";}if(typeof i==="string"){_2a[idx]=_1.filter(_2c,function(_2d){return _2d.value===i;})[0]||{value:"",label:""};}},this);_2a=_1.filter(_2a,function(i){return i&&i.value;});if(!this.multiple&&(!_2a[0]||!_2a[0].value)&&_2c.length){_2a[0]=_2c[0];}_1.forEach(_2c,function(i){i.selected=_1.some(_2a,function(v){return v.value===i.value;});});var val=_1.map(_2a,function(i){return i.value;}),_2e=_1.map(_2a,function(i){return i.label;});if(typeof val=="undefined"||typeof val[0]=="undefined"){return;}this._setDisplay(this.multiple?_2e:_2e[0]);this.inherited(arguments,[this.multiple?val:val[0],_2b]);this._updateSelection();},_getDisplayedValueAttr:function(){var val=this.get("value");if(!_9.isArray(val)){val=[val];}var ret=_1.map(this.getOptions(val),function(v){if(v&&"label" in v){return v.label;}else{if(v){return v.value;}}return null;},this);return this.multiple?ret:ret[0];},_loadChildren:function(){if(this._loadingStore){return;}_1.forEach(this._getChildren(),function(_2f){_2f.destroyRecursive();});_1.forEach(this.options,this._addOptionItem,this);this._updateSelection();},_updateSelection:function(){this._set("value",this._getValueFromOpts());var val=this.value;if(!_9.isArray(val)){val=[val];}if(val&&val[0]){_1.forEach(this._getChildren(),function(_30){var _31=_1.some(val,function(v){return _30.option&&(v===_30.option.value);});_7.toggle(_30.domNode,this.baseClass+"SelectedOption",_31);_30.domNode.setAttribute("aria-selected",_31?"true":"false");},this);}},_getValueFromOpts:function(){var _32=this.getOptions()||[];if(!this.multiple&&_32.length){var opt=_1.filter(_32,function(i){return i.selected;})[0];if(opt&&opt.value){return opt.value;}else{_32[0].selected=true;return _32[0].value;}}else{if(this.multiple){return _1.map(_1.filter(_32,function(i){return i.selected;}),function(i){return i.value;})||[];}}return "";},_onNewItem:function(_33,_34){if(!_34||!_34.parent){this._addOptionForItem(_33);}},_onDeleteItem:function(_35){var _36=this.store;this.removeOption(_36.getIdentity(_35));},_onSetItem:function(_37){this.updateOption(this._getOptionObjForItem(_37));},_getOptionObjForItem:function(_38){var _39=this.store,_3a=(this.labelAttr&&this.labelAttr in _38)?_38[this.labelAttr]:_39.getLabel(_38),_3b=(_3a?_39.getIdentity(_38):null);return {value:_3b,label:_3a,item:_38};},_addOptionForItem:function(_3c){var _3d=this.store;if(_3d.isItemLoaded&&!_3d.isItemLoaded(_3c)){_3d.loadItem({item:_3c,onItem:function(i){this._addOptionForItem(i);},scope:this});return;}var _3e=this._getOptionObjForItem(_3c);this.addOption(_3e);},constructor:function(_3f){this._oValue=(_3f||{}).value||null;this._notifyConnections=[];},buildRendering:function(){this.inherited(arguments);_6.setSelectable(this.focusNode,false);},_fillContent:function(){if(!this.options){this.options=this.srcNodeRef?_a("> *",this.srcNodeRef).map(function(_40){if(_40.getAttribute("type")==="separator"){return {value:"",label:"",selected:false,disabled:false};}return {value:(_40.getAttribute("data-"+_8._scopeName+"-value")||_40.getAttribute("value")),label:String(_40.innerHTML),selected:_40.getAttribute("selected")||false,disabled:_40.getAttribute("disabled")||false};},this):[];}if(!this.value){this._set("value",this._getValueFromOpts());}else{if(this.multiple&&typeof this.value=="string"){this._set("value",this.value.split(","));}}},postCreate:function(){this.inherited(arguments);this.connect(this,"onChange","_updateSelection");var _41=this.store;if(_41&&(_41.getIdentity||_41.getFeatures()["dojo.data.api.Identity"])){this.store=null;this.setStore(_41,this._oValue);}},startup:function(){this._loadChildren();this.inherited(arguments);},destroy:function(){var h;while((h=this._notifyConnections.pop())){h.remove();}if(this._queryRes&&this._queryRes.close){this._queryRes.close();}this.inherited(arguments);},_addOptionItem:function(){},_removeOptionItem:function(){},_setDisplay:function(){},_getChildren:function(){return [];},_getSelectedOptionsAttr:function(){return this.getOptions(this.get("value"));},_pseudoLoadChildren:function(){},onSetStore:function(){}});});