<!DOCTYPE html>
<html>
  <head>
    <title id="title_id"></title>
	<meta charset="utf-8" />
	<meta http-equiv="Cache-Control" CONTENT="no-store, no-cache, must-revalidate">
	<meta http-equiv="Cache-Control" CONTENT="post-check=0, pre-check=0">
	<meta http-equiv="Pragma" CONTENT="no-cache">
    <style type="text/css">
        @import url("maqetta/app/davinci/workbench.css?@revision@");
		html, body {
			width: 100%;
			height: 100%;
		}
    </style>
    <!-- propvieweffects.css needs to be separate and not built -->
    <!-- FIXME: This LINK element should be added by the properties palette plugin -->
    <link href="maqetta/app/davinci/propvieweffects.css?@revision@" rel="stylesheet" type="text/css"></link>
    <script type="text/javascript" src="maqetta/app/dojo/dojo.js?@revision@" data-dojo-config="parseOnLoad: true, modulePaths:{'preview':'../preview', 'system':'../system'}, cacheBust: '@revision@'"></script>
	<script type="text/javascript">
        require(["dijit/dijit", "davinci/davinci-common", "davinci/davinci", "davinci/review/Review"], function () {
        dojo.addOnLoad(function () {
            var langObj = dojo.i18n.getLocalization("davinci","webContent");
            dojo.byId("davinci_user_welcome").innerHTML = langObj.welcome;
            dojo.byId("load_screen").innerHTML = langObj.loadingMaqetta;
            dojo.byId("davinci_logoff").innerHTML = langObj.logOff;
            dojo.byId("maqetta_review").innerHTML = langObj.review;
            dojo.byId("maqetta_version").innerHTML = davinci.version;
            dojo.byId("title_id").text = langObj.reviewPageTitle;  		    });
		    
	    	davinci.useAppCache = true; // needed to provide FF "allow" warning

			davinci.Runtime.addPlugin( "maqetta/app/davinci/ui" );
	    	davinci.Runtime.addPlugin( "maqetta/app/davinci/de/de" );
		 	davinci.Runtime.addPlugin( "maqetta/app/davinci/html/html" );
		 	davinci.Runtime.addPlugin( "maqetta/app/davinci/review/review" );
			davinci.Runtime.addPlugin( "maqetta/app/davinci/ve/ve" );
			davinci.Runtime.addPlugin( "maqetta/app/davinci/ve/themeEditor/themeEditor" );


            davinci.Runtime.initialPerspective = "davinci.review.comment";
            
			dojo.addOnLoad(function() {
			    // Display a warning dialog for unsupported browsers
				if (!(dojo.isFF >= 4 || dojo.isChrome >= 5 || dojo.isSafari >= 5.1)) {
					var langObj = dojo.i18n.getLocalization("davinci","webContent");
	                var unsupportedDialog = new dijit.Dialog({
	                    id: "unsupportedBrowserDialog",
	                    title: langObj.unsupportedBrowser,
	                    content: ["<p>"+ langObj.unsupportedNote +"</p>",
	                              "<div class='maqButtonArea'>",
	                              "   <button dojoType='dijit.form.Button' type='submit'>",
	                              langObj.buttonContinue,
	                              "   </button>",
	                              "</div>"
	                             ].join(" "),
	                    execute: function() { run(); }
	                });
				    unsupportedDialog.show();
				} else {
				    run();
				}

                function run() {
                    davinci.Runtime.commenting_designerName = dojo.cookie("davinci_designer");
                    davinci.Runtime.commenting_designerEmail = dojo.cookie("davinci_designer_email");
                    davinci.Runtime.commenting_openFile = dojo.cookie("davinci_file");
                    davinci.Runtime.commenting_commentId = dojo.cookie("davinci_commentId");
                    dojo.cookie("davinci_designer", null, {expires: -1});
                    dojo.cookie("davinci_designer_email", null, {expires: -1});
                    dojo.cookie("davinci_file", null, {expires: -1});
                    dojo.cookie("davinci_commentId", null, {expires: -1});
    
                    var userInfo;
                    var result = davinci.Runtime.serverJSONRequest({
                        url: "maqetta/cmd/getReviewUserInfo",
                        sync: true
                    });
    
                    if(!result) return;
                    if (result && result.userName) {
                        dojo.byId('davinci_user').innerHTML = result.userName;
                         davinci.Runtime.userName=result;
                    } else {
                            //FIXME: temporary fix for running via file: URLs
                           var langObj = dojo.i18n.getLocalization("davinci","webContent");
                           dojo.byId('davinci_user').innerHTML=langObj.maqettaUser;
                    }
                    davinci.Runtime.commenting_reviewerName = result;
                    if (result && result.isLocalInstall) {
                        //dojo.style(dojo.byId('davinci_user_container'), "visibility", "hidden");
                        davinci.Runtime.isLocalInstall = true;
                    }
    
                    davinci.Runtime.subscribe("/davinci/ui/selectionChanged",davinci.Runtime._selectionChanged);
                    davinci.Workbench.runComment();
                    // intercept BS key - prevent browser from navigating backwards
                    dojo.connect(dojo.doc.documentElement, "onkeypress", function(e) {
                        // If explicitOriginalTarget is <html> element, then no elements have focus
                        var target=e.target;
                        if(target && (target.nodeName=="HTML"||target.nodeName=="BODY") && e.charOrCode==8) {
                            dojo.stopEvent(e);
                        }
                    });
    
    
                    if(davinci.Runtime.commenting_openFile) {
                        var page = davinci.Runtime.commenting_openFile;
                        var path = new davinci.model.Path(page);
                        var version = path.getSegments()[0];
                        path.removeFirstSegments(1);
                        var node = davinci.review.model.Resource.root.findFile(version, path.toString());
                        if (node) {
                            davinci.Workbench.openEditor({
                                fileName: node,
                                content: node.getText()
                            });
                        }
                    }
                } // END function run
    
                dojo.addOnUnload(davinci.Runtime.unload);
            });
        });
	</script>
  </head>

	<body class="claro">
		<div class="loading"><table><tr><td id="load_screen"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;</td></tr></table></div>
		<div id="davinci_app">
			<div id="davinci_top_bar">
					<div id="davinci_user_container">
						<span id="davinci_user_welcome"></span>
						<span id="davinci_user"></span>
						<span id="davinci_main_menu"> </span>
						<a id="davinci_logoff" href='javascript:davinci.Runtime.logoff()'> </a>
					</div>
					<span class="maq_banner_name_box">
						<span class="maq_banner_name">Maqetta</span>
						<span id="maqetta_review" class="maq_banner_component"></span>
						<span id="maqetta_version" class="maq_banner_version"></span>

					</span>
<!-- no toolbar for now, uncomment and put in desired location, and toolbar will be generated based on actions
					<div id="toolbar_container">
						<span id="davinci_toolbar_main"></span>
					</div>
-->
			</div>
			<div id="mainBody"></div>
		</div>
	</body>
</html>
